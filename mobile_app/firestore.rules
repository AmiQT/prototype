rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isAdmin() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    function isLecturer() {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'lecturer';
    }
    
    function isValidPostData(data) {
      return data.keys().hasAll(['userId', 'userName', 'content', 'type', 
                                'category', 'privacy', 'createdAt', 'updatedAt']) &&
             data.userId is string &&
             data.userName is string &&
             data.content is string &&
             data.type in ['text', 'image', 'video', 'mixed'] &&
             data.category in ['academic', 'creative', 'technical', 'sports', 
                              'volunteer', 'achievement', 'project', 'general'] &&
             data.privacy in ['public', 'department', 'friends'] &&
             data.createdAt is timestamp &&
             data.updatedAt is timestamp &&
             data.likes is list &&
             data.comments is list &&
             data.shares is list;
    }
    
    function canReadPost(postData) {
      return postData.privacy == 'public' ||
             (postData.privacy == 'department' && 
              request.auth.token.department == postData.userDepartment) ||
             (postData.privacy == 'friends' && 
              (request.auth.uid == postData.userId || 
               isConnectedUser(request.auth.uid, postData.userId)));
    }
    
    function isConnectedUser(currentUserId, targetUserId) {
      // Placeholder for friend/connection system
      return false;
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isOwner(userId);
    }

    // Sample data collection - for testing purposes
    match /sample_users/{userId} {
      allow read, write: if isAuthenticated();
    }
    
    // Profiles collection
    match /profiles/{profileId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && (
        isOwner(request.resource.data.userId) ||
        profileId.matches('^sample_user_[0-9]+$') // Allow creating sample profiles
      );
      allow update: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        isOwner(request.resource.data.userId) ||
        profileId.matches('^sample_user_[0-9]+$') // Allow updating sample profiles
      );
      allow delete: if isAuthenticated() && (
        isOwner(resource.data.userId) ||
        profileId.matches('^sample_user_[0-9]+$') // Allow deleting sample profiles
      );
    }
    
    // Showcase Posts Collection
    match /showcase_posts/{postId} {
      allow read: if isAuthenticated() && canReadPost(resource.data);
      allow create: if isAuthenticated() && 
        isOwner(request.resource.data.userId) &&
        isValidPostData(request.resource.data);
      allow update: if isAuthenticated() && 
        isOwner(resource.data.userId) &&
        request.resource.data.userId == resource.data.userId &&
        request.resource.data.createdAt == resource.data.createdAt;
      allow delete: if isAuthenticated() && isOwner(resource.data.userId);
    }
    
    // Search history
    match /search_history/{userId} {
      allow read, write: if isAuthenticated() && isOwner(userId);
    }

    // Reports collection - SECURE: restricted access
    match /reports/{reportId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated() &&
        (request.auth.uid == resource.data.reporterId || isAdmin());
      allow update, delete: if isAuthenticated() && isAdmin();
    }

    // Moderation actions collection - SECURE: admin/lecturer only
    match /moderationActions/{actionId} {
      allow read: if isAuthenticated() && (isAdmin() || isLecturer());
      allow write: if isAuthenticated() && isAdmin();
    }

    // Chat messages collection - SECURE: participants only
    match /chat_messages/{messageId} {
      allow read: if isAuthenticated() &&
        (request.auth.uid == resource.data.userId ||
         request.auth.uid == resource.data.recipientId);
      allow create: if isAuthenticated() &&
        request.auth.uid == request.resource.data.userId;
      allow update, delete: if isAuthenticated() &&
        request.auth.uid == resource.data.userId;
    }

    // Chat conversations collection - SECURE: participants only
    match /chat_conversations/{conversationId} {
      allow read: if isAuthenticated() &&
        request.auth.uid in resource.data.participants;
      allow create: if isAuthenticated() &&
        request.auth.uid in request.resource.data.participants;
      allow update: if isAuthenticated() &&
        request.auth.uid in resource.data.participants;
      allow delete: if isAuthenticated() &&
        request.auth.uid in resource.data.participants;
    }

    // SECURITY: DANGEROUS GLOBAL READ ACCESS RULE REMOVED
    // The /{document=**} rule has been ELIMINATED for security
    // All access is now controlled by specific collection rules above
  }
}
