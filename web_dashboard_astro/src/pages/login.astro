---
import MainLayout from '../layouts/MainLayout.astro';
---

<MainLayout title="UTHM Talent Profiling - Admin Login">
    <!-- Animated Background -->
    <div class="fixed inset-0 -z-10 overflow-hidden bg-gradient-to-br from-[#667eea] via-[#764ba2] to-[#4facfe] bg-[length:400%_400%] animate-gradient-shift">
        <div class="absolute rounded-full bg-white/10 backdrop-blur-md animate-float w-[120px] h-[120px] top-[10%] left-[10%]"></div>
        <div class="absolute rounded-full bg-white/10 backdrop-blur-md animate-float w-[80px] h-[80px] top-[70%] left-[80%] delay-1000"></div>
        <div class="absolute rounded-full bg-white/10 backdrop-blur-md animate-float w-[60px] h-[60px] top-[30%] left-[85%] delay-2000"></div>
        <div class="absolute rounded-full bg-white/10 backdrop-blur-md animate-float w-[100px] h-[100px] top-[80%] left-[5%] delay-3000"></div>
        <div class="absolute rounded-full bg-white/10 backdrop-blur-md animate-float w-[140px] h-[140px] top-[50%] left-[5%] delay-4000"></div>
    </div>

    <div class="flex items-center justify-center min-h-screen p-4 md:p-8 relative z-10">
        <div class="flex flex-col lg:flex-row w-full max-w-[1400px] min-h-[700px] bg-white/95 backdrop-blur-xl rounded-3xl shadow-2xl overflow-hidden animate-card-slide-in">
            <!-- Branding Panel -->
            <div class="hidden lg:block w-[55%] relative bg-gradient-to-br from-[#677eea]/90 via-[#764ba2]/90 to-[#f093fb]/80 text-white overflow-hidden">
                <div class="absolute -top-1/2 -left-1/2 w-[200%] h-[200%] bg-[radial-gradient(circle,rgba(255,255,255,0.1)_1px,transparent_1px)] bg-[size:30px_30px] animate-background-move"></div>
                
                <div class="relative z-10 h-full flex flex-col justify-center p-16">
                    <div class="relative w-[120px] h-[120px] mx-auto mb-12 animate-logo-fade-in">
                        <div class="absolute inset-[-10px] bg-white/20 rounded-full backdrop-blur-md animate-pulse"></div>
                        <img src="/uthm.png" alt="UTHM Logo" class="w-full h-full object-contain relative z-10 drop-shadow-xl">
                    </div>
                    
                    <div class="text-center mb-12">
                        <h1 class="text-5xl font-bold leading-tight mb-6">
                            <span class="block">Empowering Admins</span>
                            <span class="block">with Innovative</span>
                            <span class="block bg-gradient-to-r from-white to-blue-50 bg-clip-text text-transparent relative after:content-[''] after:absolute after:-bottom-1 after:left-1/2 after:-translate-x-1/2 after:w-3/5 after:h-[3px] after:bg-gradient-to-r after:from-transparent after:via-white after:to-transparent">Solutions</span>
                        </h1>
                        <p class="text-lg opacity-90 leading-relaxed">
                            Transform student talent management with our comprehensive platform designed for modern educational excellence.
                        </p>
                    </div>
                    
                    <div class="flex justify-center gap-8 flex-wrap">
                        <div class="flex flex-col items-center gap-2 p-4 bg-white/15 rounded-2xl backdrop-blur-md border border-white/20 min-w-[120px] hover:-translate-y-1 hover:bg-white/25 transition-all duration-300">
                            <i class="fas fa-chart-line text-2xl mb-2"></i>
                            <span class="text-sm font-medium">Real-time Analytics</span>
                        </div>
                        <div class="flex flex-col items-center gap-2 p-4 bg-white/15 rounded-2xl backdrop-blur-md border border-white/20 min-w-[120px] hover:-translate-y-1 hover:bg-white/25 transition-all duration-300">
                            <i class="fas fa-users text-2xl mb-2"></i>
                            <span class="text-sm font-medium">Student Management</span>
                        </div>
                        <div class="flex flex-col items-center gap-2 p-4 bg-white/15 rounded-2xl backdrop-blur-md border border-white/20 min-w-[120px] hover:-translate-y-1 hover:bg-white/25 transition-all duration-300">
                            <i class="fas fa-shield-alt text-2xl mb-2"></i>
                            <span class="text-sm font-medium">Secure Platform</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Panel -->
            <div class="w-full lg:w-[45%] p-8 md:p-16 flex flex-col justify-center bg-white/95 relative">
                <div class="w-full max-w-[400px] mx-auto">
                    <div class="text-center mb-12">
                        <h2 class="text-4xl font-bold text-gray-900 mb-2 bg-gradient-to-br from-[#667eea] to-[#764ba2] bg-clip-text text-transparent">Welcome Back</h2>
                        <p class="text-slate-500 text-base">Please sign in to your admin account</p>
                    </div>

                    <form id="login-form" class="space-y-8">
                        <!-- Message Container -->
                        <div id="message-container" class="mb-6 min-h-0 overflow-hidden">
                            <div id="error-message" class="hidden flex items-center gap-3 p-4 rounded-xl text-sm font-medium bg-red-50 text-red-600 border border-red-200 animate-shake">
                                <i class="fas fa-exclamation-circle text-lg"></i>
                                <span class="message-text"></span>
                            </div>
                            <div id="success-message" class="hidden flex items-center gap-3 p-4 rounded-xl text-sm font-medium bg-green-50 text-green-600 border border-green-200">
                                <i class="fas fa-check-circle text-lg"></i>
                                <span class="message-text"></span>
                            </div>
                        </div>

                        <!-- Email Input -->
                        <div class="group relative">
                            <div class="relative">
                                <i class="fas fa-envelope absolute left-5 top-1/2 -translate-y-1/2 text-slate-400 text-lg transition-colors duration-300 group-focus-within:text-[#667eea]"></i>
                                <input type="email" id="email" name="email" required 
                                    class="peer w-full h-[60px] px-4 pl-12 border-2 border-slate-200 rounded-2xl text-base font-medium text-gray-900 bg-white/80 backdrop-blur-sm transition-all duration-300 outline-none focus:border-[#667eea] focus:bg-white/95 focus:shadow-[0_0_0_4px_rgba(102,126,234,0.1)] focus:-translate-y-0.5 placeholder-transparent"
                                    placeholder="Email Address">
                                <label for="email" 
                                    class="absolute left-12 top-1/2 -translate-y-1/2 text-base font-medium text-slate-500 pointer-events-none transition-all duration-300 peer-focus:-top-3 peer-focus:left-4 peer-focus:text-xs peer-focus:text-[#667eea] peer-focus:bg-white/90 peer-focus:px-2 peer-focus:rounded-lg peer-focus:backdrop-blur-md peer-[:not(:placeholder-shown)]:-top-3 peer-[:not(:placeholder-shown)]:left-4 peer-[:not(:placeholder-shown)]:text-xs peer-[:not(:placeholder-shown)]:text-[#667eea] peer-[:not(:placeholder-shown)]:bg-white/90 peer-[:not(:placeholder-shown)]:px-2 peer-[:not(:placeholder-shown)]:rounded-lg">
                                    Email Address
                                </label>
                                <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-0 h-[2px] bg-gradient-to-r from-[#667eea] to-[#764ba2] transition-all duration-300 peer-focus:w-full"></div>
                            </div>
                        </div>

                        <!-- Password Input -->
                        <div class="group relative">
                            <div class="relative">
                                <i class="fas fa-lock absolute left-5 top-1/2 -translate-y-1/2 text-slate-400 text-lg transition-colors duration-300 group-focus-within:text-[#667eea]"></i>
                                <input type="password" id="password" name="password" required 
                                    class="peer w-full h-[60px] px-4 pl-12 border-2 border-slate-200 rounded-2xl text-base font-medium text-gray-900 bg-white/80 backdrop-blur-sm transition-all duration-300 outline-none focus:border-[#667eea] focus:bg-white/95 focus:shadow-[0_0_0_4px_rgba(102,126,234,0.1)] focus:-translate-y-0.5 placeholder-transparent"
                                    placeholder="Password">
                                <label for="password" 
                                    class="absolute left-12 top-1/2 -translate-y-1/2 text-base font-medium text-slate-500 pointer-events-none transition-all duration-300 peer-focus:-top-3 peer-focus:left-4 peer-focus:text-xs peer-focus:text-[#667eea] peer-focus:bg-white/90 peer-focus:px-2 peer-focus:rounded-lg peer-focus:backdrop-blur-md peer-[:not(:placeholder-shown)]:-top-3 peer-[:not(:placeholder-shown)]:left-4 peer-[:not(:placeholder-shown)]:text-xs peer-[:not(:placeholder-shown)]:text-[#667eea] peer-[:not(:placeholder-shown)]:bg-white/90 peer-[:not(:placeholder-shown)]:px-2 peer-[:not(:placeholder-shown)]:rounded-lg">
                                    Password
                                </label>
                                <button type="button" id="password-toggle" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 hover:text-[#667eea] hover:bg-[#667eea]/10 p-2 rounded-lg transition-all duration-300">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-0 h-[2px] bg-gradient-to-r from-[#667eea] to-[#764ba2] transition-all duration-300 peer-focus:w-full"></div>
                            </div>
                        </div>

                        <!-- Form Options -->
                        <div class="flex items-center justify-between">
                            <label class="flex items-center gap-3 cursor-pointer group">
                                <input type="checkbox" id="remember-checkbox" class="hidden peer">
                                <span class="w-5 h-5 border-2 border-slate-200 rounded-md flex items-center justify-center bg-white/80 transition-all duration-300 peer-checked:bg-gradient-to-br peer-checked:from-[#667eea] peer-checked:to-[#764ba2] peer-checked:border-[#667eea] peer-checked:scale-110">
                                    <i class="fas fa-check text-xs text-white opacity-0 scale-0 transition-all duration-300 peer-checked:opacity-100 peer-checked:scale-100"></i>
                                </span>
                                <span class="text-sm font-medium text-slate-600 transition-colors duration-300 group-hover:text-[#667eea]">Remember Me</span>
                            </label>
                            <a href="#" class="text-sm font-medium text-[#667eea] flex items-center gap-2 p-2 rounded-lg transition-all duration-300 hover:bg-[#667eea]/10 hover:translate-x-0.5">
                                <i class="fas fa-key"></i>
                                Forgot Password?
                            </a>
                        </div>

                        <!-- Login Button -->
                        <button type="submit" id="login-btn" class="w-full h-[60px] bg-gradient-to-br from-[#667eea] to-[#764ba2] text-white rounded-2xl text-lg font-semibold cursor-pointer relative overflow-hidden transition-all duration-300 hover:-translate-y-1 hover:shadow-lg hover:shadow-[#667eea]/40 active:-translate-y-0.5 disabled:cursor-not-allowed disabled:opacity-70">
                            <span class="btn-content flex items-center justify-center gap-3 transition-all duration-300">
                                <span>Sign In</span>
                                <i class="fas fa-arrow-right text-sm transition-transform duration-300 group-hover:translate-x-1"></i>
                            </span>
                            <div id="loading" class="absolute inset-0 hidden items-center justify-center gap-3 bg-inherit">
                                <div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                                <span>Signing In...</span>
                            </div>
                            <div class="btn-ripple absolute bg-white/30 rounded-full pointer-events-none scale-0 transition-transform duration-600"></div>
                        </button>

                        <!-- Footer -->
                        <div class="mt-8 text-center">
                            <p class="text-sm text-slate-500 flex items-center justify-center gap-2 flex-wrap">
                                <i class="fas fa-info-circle"></i>
                                Need help? Contact IT support at 
                                <a href="mailto:support@uthm.edu.my" class="text-[#667eea] font-medium hover:text-[#764ba2] transition-colors duration-300">support@uthm.edu.my</a>
                            </p>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</MainLayout>

<style>
    /* Custom Animations that are tricky with just Tailwind utilities */
    @keyframes gradientShift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        33% { transform: translateY(-20px) rotate(5deg); }
        66% { transform: translateY(10px) rotate(-5deg); }
    }

    @keyframes backgroundMove {
        0% { transform: translate(0, 0); }
        100% { transform: translate(30px, 30px); }
    }

    .animate-gradient-shift {
        animation: gradientShift 15s ease infinite;
    }

    .animate-float {
        animation: float 6s ease-in-out infinite;
    }

    .animate-background-move {
        animation: backgroundMove 20s linear infinite;
    }

    .animate-card-slide-in {
        animation: cardSlideIn 0.8s cubic-bezier(0.23, 1, 0.32, 1);
    }

    .animate-logo-fade-in {
        animation: logoFadeIn 1s ease-out 0.5s both;
    }

    .animate-line-slide-in {
        animation: lineSlideIn 0.8s ease-out forwards;
    }

    .animate-fade-in-up {
        animation: fadeInUp 1s ease-out both;
    }

    .animate-slide-down {
        animation: slideDown 0.8s ease-out both;
    }

    .animate-slide-up {
        animation: slideUp 0.6s ease-out forwards;
    }

    .animate-shake {
        animation: shake 0.5s ease-in-out;
    }

    @keyframes cardSlideIn {
        from { opacity: 0; transform: translateY(60px) scale(0.95); }
        to { opacity: 1; transform: translateY(0px) scale(1); }
    }

    @keyframes logoFadeIn {
        from { opacity: 0; transform: scale(0.5) rotate(-10deg); }
        to { opacity: 1; transform: scale(1) rotate(0deg); }
    }

    @keyframes lineSlideIn {
        from { opacity: 0; transform: translateX(-30px); }
        to { opacity: 1; transform: translateX(0); }
    }

    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-30px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideUp {
        from { opacity: 0; transform: translateY(40px); }
        to { opacity: 1; transform: translateY(0); }
    }

    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-10px); }
        75% { transform: translateX(10px); }
    }

    .fill-mode-both { animation-fill-mode: both; }
    .fill-mode-forwards { animation-fill-mode: forwards; }
</style>

<script>
    // Client-side logic
    import { supabase } from '../lib/supabase';
    import { DEMO_CREDENTIALS, setDemoMode } from '../lib/demoStore';

    // Initialize UI interactions
    document.addEventListener('DOMContentLoaded', () => {
        const passwordToggle = document.getElementById('password-toggle');
        const passwordInput = document.getElementById('password') as HTMLInputElement;
        const loginBtn = document.getElementById('login-btn') as HTMLButtonElement;
        const loginForm = document.getElementById('login-form');
        const loading = document.getElementById('loading');
        const btnContent = document.querySelector('.btn-content') as HTMLElement;

        // Password Toggle
        passwordToggle?.addEventListener('click', () => {
            const type = passwordInput.type === 'password' ? 'text' : 'password';
            passwordInput.type = type;
            const icon = passwordToggle.querySelector('i');
            icon?.classList.toggle('fa-eye');
            icon?.classList.toggle('fa-eye-slash');
        });

        // Ripple Effect
        loginBtn?.addEventListener('click', function(e) {
            if (!this.disabled) {
                const ripple = this.querySelector('.btn-ripple') as HTMLElement;
                const rect = this.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                const x = e.clientX - rect.left - size / 2;
                const y = e.clientY - rect.top - size / 2;
                
                ripple.style.width = ripple.style.height = size + 'px';
                ripple.style.left = x + 'px';
                ripple.style.top = y + 'px';
                
                ripple.classList.remove('scale-0');
                ripple.classList.add('scale-150', 'opacity-0');
                
                setTimeout(() => {
                    ripple.classList.remove('scale-150', 'opacity-0');
                    ripple.classList.add('scale-0');
                }, 600);
            }
        });

        // Form Submission
        loginForm?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // UI Loading State
            loginBtn.disabled = true;
            btnContent.style.opacity = '0';
            loading?.classList.remove('hidden');
            loading?.classList.add('flex');

            const email = (document.getElementById('email') as HTMLInputElement).value;
            const password = (document.getElementById('password') as HTMLInputElement).value;

            try {
                // CHECK FOR DEMO LOGIN FIRST
                if (email === DEMO_CREDENTIALS.email && password === DEMO_CREDENTIALS.password) {
                    console.log('Entering Demo Mode...');
                    // Simulate network delay for realism
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    setDemoMode(true);
                    window.location.href = '/dashboard';
                    return;
                }

                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) {
                    throw error;
                }

                // Check user role
                const { data: profileData, error: profileError } = await supabase
                    .from('users')
                    .select('role')
                    .eq('email', email)
                    .single();

                if (profileError) {
                    console.warn('Failed to fetch user profile:', profileError.message);
                }

                const role = profileData?.role ?? data?.user?.user_metadata?.role;
                if (role && !['admin', 'manager'].includes(role)) {
                    await supabase.auth.signOut();
                    throw new Error('Access restricted to admin users only');
                }

                // Success
                window.location.href = '/dashboard';

            } catch (error: any) {
                console.error('Login failed:', error);
                alert(error.message || 'Login failed');
                
                // Reset UI
                loginBtn.disabled = false;
                btnContent.style.opacity = '1';
                loading?.classList.add('hidden');
                loading?.classList.remove('flex');
            }
        });
    });
</script>
