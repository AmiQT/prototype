---
import DashboardLayout from "../../layouts/DashboardLayout.astro";
---

<DashboardLayout title="User Management" activeSection="users">
    <div
        class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden"
    >
        <div
            class="p-6 border-b border-gray-100 flex flex-col md:flex-row md:items-center justify-between gap-4"
        >
            <div class="flex items-center gap-4 flex-1">
                <div class="relative flex-1 max-w-md">
                    <i
                        class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"
                    ></i>
                    <input
                        type="text"
                        placeholder="Search users..."
                        class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-xl focus:outline-none focus:border-[#667eea] focus:ring-2 focus:ring-[#667eea]/10 transition-all"
                    />
                </div>
                <select
                    class="px-4 py-2 border border-gray-200 rounded-xl focus:outline-none focus:border-[#667eea] bg-white text-gray-600"
                >
                    <option value="">All Roles</option>
                    <option value="student">Students</option>
                    <option value="lecturer">Lecturers</option>
                    <option value="admin">Admins</option>
                </select>
            </div>
            <button
                id="add-user-btn"
                class="px-4 py-2 bg-[#667eea] text-white rounded-xl hover:bg-[#5a6fd6] transition-colors flex items-center gap-2 shadow-lg shadow-[#667eea]/30"
            >
                <i class="fas fa-plus"></i>
                <span>Add User</span>
            </button>
        </div>

        <!-- Bulk Action Bar (hidden by default) -->
        <div
            id="bulk-action-bar"
            class="hidden px-6 py-3 bg-blue-50 border-b border-blue-100 flex items-center justify-between"
        >
            <div class="flex items-center gap-2 text-sm text-blue-700">
                <i class="fas fa-check-circle"></i>
                <span id="selected-count">0</span> user(s) selected
            </div>
            <div class="flex items-center gap-2">
                <select
                    id="bulk-action-select"
                    class="px-3 py-1.5 border border-blue-200 rounded-lg bg-white text-sm focus:outline-none focus:border-[#667eea]"
                >
                    <option value="">Choose Action...</option>
                    <option value="delete">Delete Selected</option>
                    <option value="activate">Set Active</option>
                    <option value="deactivate">Set Inactive</option>
                </select>
                <button
                    id="apply-bulk-action"
                    class="px-3 py-1.5 bg-[#667eea] text-white rounded-lg text-sm hover:bg-[#5a6fd6] transition-colors"
                >
                    Apply
                </button>
                <button
                    id="clear-selection"
                    class="px-3 py-1.5 text-gray-500 hover:text-gray-700 text-sm"
                >
                    Clear
                </button>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-4 text-left">
                            <input
                                type="checkbox"
                                id="select-all-users"
                                class="w-4 h-4 rounded border-gray-300 text-[#667eea] focus:ring-[#667eea]"
                            />
                        </th>
                        <th
                            class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"
                            >Student ID</th
                        >
                        <th
                            class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"
                            >Name</th
                        >
                        <th
                            class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"
                            >Role</th
                        >
                        <th
                            class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"
                            >Department</th
                        >
                        <th
                            class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"
                            >Profile</th
                        >
                        <th
                            class="px-6 py-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider"
                            >Status</th
                        >
                        <th
                            class="px-6 py-4 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider"
                            >Actions</th
                        >
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100" id="users-table-body">
                    <tr>
                        <td
                            colspan="7"
                            class="px-6 py-8 text-center text-gray-500"
                        >
                            <div class="flex flex-col items-center gap-2">
                                <i
                                    class="fas fa-circle-notch fa-spin text-2xl text-[#667eea]"
                                ></i>
                                <span>Loading users...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div
            class="p-4 border-t border-gray-100 flex items-center justify-between text-sm text-gray-500"
        >
            <span
                >Showing 1 to 10 of <span id="total-count">0</span> entries</span
            >
            <div class="flex gap-2">
                <button
                    class="px-3 py-1 border border-gray-200 rounded-lg hover:bg-gray-50 disabled:opacity-50"
                    disabled>Previous</button
                >
                <button
                    class="px-3 py-1 border border-gray-200 rounded-lg hover:bg-gray-50"
                    >Next</button
                >
            </div>
        </div>
        <!-- Add User Modal -->
        <div
            id="add-user-modal"
            class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50"
        >
            <div
                class="bg-white rounded-2xl p-6 w-full max-w-md mx-4 shadow-2xl transform transition-all"
            >
                <h3 class="text-xl font-bold text-gray-800 mb-4">
                    Add New User
                </h3>
                <form id="add-user-form" class="space-y-4">
                    <div>
                        <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                            >Name</label
                        >
                        <input
                            type="text"
                            id="add-name"
                            class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:outline-none focus:border-[#667eea]"
                            required
                            placeholder="e.g. Ali bin Abu"
                        />
                    </div>

                    <div>
                        <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                            >Email</label
                        >
                        <input
                            type="email"
                            id="add-email"
                            class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:outline-none focus:border-[#667eea]"
                            required
                            placeholder="e.g. ali@student.uthm.edu.my"
                        />
                    </div>

                    <div>
                        <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                            >Password</label
                        >
                        <input
                            type="password"
                            id="add-password"
                            class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:outline-none focus:border-[#667eea]"
                            required
                            placeholder="Enter a secure password"
                        />
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700 mb-1"
                                >Role</label
                            >
                            <select
                                id="add-role"
                                class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:outline-none focus:border-[#667eea]"
                            >
                                <option value="student">Student</option>
                                <option value="lecturer">Lecturer</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700 mb-1"
                                >Department</label
                            >
                            <input
                                type="text"
                                id="add-department"
                                class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:outline-none focus:border-[#667eea]"
                                placeholder="e.g. FSKTM"
                            />
                        </div>
                        <div class="col-span-2">
                            <label
                                class="block text-sm font-medium text-gray-700 mb-1"
                                >ID Number (Student/Staff ID)</label
                            >
                            <input
                                type="text"
                                id="add-student-id"
                                class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:outline-none focus:border-[#667eea]"
                                placeholder="e.g. AI210001 or Staff ID"
                            />
                        </div>
                    </div>

                    <div class="flex justify-end gap-3 mt-6">
                        <button
                            type="button"
                            onclick="document.getElementById('add-user-modal').classList.add('hidden'); document.getElementById('add-user-modal').classList.remove('flex');"
                            class="px-4 py-2 text-gray-500 hover:text-gray-700 font-medium"
                        >
                            Cancel
                        </button>
                        <button
                            type="submit"
                            class="px-4 py-2 bg-[#667eea] text-white rounded-xl hover:bg-[#5a6fd6] transition-colors shadow-lg shadow-[#667eea]/30"
                        >
                            Add User
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit User Modal -->
        <div
            id="edit-user-modal"
            class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50"
        >
            <div
                class="bg-white rounded-2xl p-6 w-full max-w-md mx-4 shadow-2xl transform transition-all"
            >
                <h3 class="text-xl font-bold text-gray-800 mb-4">Edit User</h3>
                <form id="edit-user-form" class="space-y-4">
                    <input type="hidden" id="edit-user-id" />

                    <div>
                        <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                            >Name</label
                        >
                        <input
                            type="text"
                            id="edit-name"
                            class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:outline-none focus:border-[#667eea]"
                            required
                        />
                    </div>

                    <div>
                        <label
                            class="block text-sm font-medium text-gray-700 mb-1"
                            >Email</label
                        >
                        <input
                            type="email"
                            id="edit-email"
                            class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:outline-none focus:border-[#667eea]"
                            required
                        />
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700 mb-1"
                                >Role</label
                            >
                            <select
                                id="edit-role"
                                class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:outline-none focus:border-[#667eea]"
                            >
                                <option value="student">Student</option>
                                <option value="lecturer">Lecturer</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div>
                            <label
                                class="block text-sm font-medium text-gray-700 mb-1"
                                >Department</label
                            >
                            <input
                                type="text"
                                id="edit-department"
                                class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:outline-none focus:border-[#667eea]"
                            />
                        </div>
                        <div class="col-span-2">
                            <label
                                class="block text-sm font-medium text-gray-700 mb-1"
                                >ID Number (Student/Staff ID)</label
                            >
                            <input
                                type="text"
                                id="edit-student-id"
                                class="w-full px-4 py-2 border border-gray-200 rounded-xl focus:outline-none focus:border-[#667eea]"
                                placeholder="e.g. AI210001"
                            />
                        </div>
                    </div>

                    <div class="flex justify-end gap-3 mt-6">
                        <button
                            type="button"
                            onclick="document.getElementById('edit-user-modal').classList.add('hidden'); document.getElementById('edit-user-modal').classList.remove('flex');"
                            class="px-4 py-2 text-gray-500 hover:text-gray-700 font-medium"
                        >
                            Cancel
                        </button>
                        <button
                            type="submit"
                            class="px-4 py-2 bg-[#667eea] text-white rounded-xl hover:bg-[#5a6fd6] transition-colors shadow-lg shadow-[#667eea]/30"
                        >
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</DashboardLayout>

<script>
    import { supabase } from "../../lib/supabase";

    // Add User Logic
    const addModal = document.getElementById("add-user-modal");
    const addBtn = document.getElementById("add-user-btn");
    const addForm = document.getElementById("add-user-form");

    const BACKEND_URL =
        import.meta.env.PUBLIC_BACKEND_URL ||
        "https://infrared-booth-auckland-prevention.trycloudflare.com";

    addBtn?.addEventListener("click", () => {
        addModal?.classList.remove("hidden");
        addModal?.classList.add("flex");
    });

    addForm?.addEventListener("submit", async (e) => {
        e.preventDefault();

        const submitButton = addForm.querySelector('button[type="submit"]');
        if (!submitButton) return;

        // Disable button and show loading state
        (submitButton as HTMLButtonElement).disabled = true;
        (submitButton as HTMLButtonElement).innerHTML =
            '<i class="fas fa-circle-notch fa-spin mr-2"></i>Adding...';

        const name = (document.getElementById("add-name") as HTMLInputElement)
            .value;
        const email = (document.getElementById("add-email") as HTMLInputElement)
            .value;
        const password = (
            document.getElementById("add-password") as HTMLInputElement
        ).value;
        const role = (document.getElementById("add-role") as HTMLSelectElement)
            .value;
        const department = (
            document.getElementById("add-department") as HTMLInputElement
        ).value;
        const studentId = (
            document.getElementById("add-student-id") as HTMLInputElement
        ).value;

        try {
            // Get current session for admin authorization
            const {
                data: { session },
            } = await supabase.auth.getSession();
            const token = session?.access_token;

            if (!token) {
                throw new Error(
                    "No authentication token found. Please login again.",
                );
            }

            // Call Backend Admin API to create user (bypasses email verification)
            const response = await fetch(
                `${BACKEND_URL}/api/users/admin/create`,
                {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer ${token}`,
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password,
                        name: name,
                        role: role,
                        department: department,
                        student_id: studentId,
                        is_active: true,
                    }),
                },
            );

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.detail || "Failed to create user");
            }

            alert("User added successfully! They can login immediately.");
            (addForm as HTMLFormElement).reset();
            addModal?.classList.add("hidden");
            addModal?.classList.remove("flex");
            window.location.reload();
        } catch (error: unknown) {
            console.error("Error adding user:", error);
            alert(
                "Failed to add user: " +
                    (error instanceof Error ? error.message : "Unknown error"),
            );
        } finally {
            // Re-enable button and restore original state
            (submitButton as HTMLButtonElement).disabled = false;
            (submitButton as HTMLButtonElement).innerHTML =
                "<span>Add User</span>";
        }
    });

    // Edit User Logic

    const editModal = document.getElementById("edit-user-modal");
    const editForm = document.getElementById("edit-user-form");
    const nameInput = document.getElementById("edit-name") as HTMLInputElement;
    const emailInput = document.getElementById(
        "edit-email",
    ) as HTMLInputElement;
    const roleInput = document.getElementById("edit-role") as HTMLSelectElement;
    const deptInput = document.getElementById(
        "edit-department",
    ) as HTMLInputElement;
    const idNumInput = document.getElementById(
        "edit-student-id",
    ) as HTMLInputElement;
    const idInput = document.getElementById("edit-user-id") as HTMLInputElement;

    (window as any).editUser = async (userId: string) => {
        try {
            const { data: user, error } = await supabase
                .from("users")
                .select("*")
                .eq("id", userId)
                .single();

            if (error) throw error;

            // Populate form
            idInput.value = user.id;
            nameInput.value = user.name || "";
            emailInput.value = user.email || "";
            roleInput.value = user.role || "student";
            deptInput.value = user.department || "";
            // Populate Student ID or Staff ID
            idNumInput.value = user.student_id || user.staff_id || "";

            // Show modal
            editModal?.classList.remove("hidden");
            editModal?.classList.add("flex");
        } catch (error) {
            console.error("Error fetching user:", error);
            alert("Failed to load user details");
        }
    };

    // Handle Save
    editForm?.addEventListener("submit", async (e) => {
        e.preventDefault();

        const submitButton = editForm.querySelector('button[type="submit"]');
        if (!submitButton) return;

        // Disable button and show loading state
        (submitButton as HTMLButtonElement).disabled = true;
        (submitButton as HTMLButtonElement).innerHTML =
            '<i class="fas fa-circle-notch fa-spin mr-2"></i>Saving...';

        const userId = idInput.value;
        const updates = {
            name: nameInput.value,
            email: emailInput.value,
            role: roleInput.value,
            department: deptInput.value,
            student_id: idNumInput.value, // Update student_id
            staff_id: roleInput.value === 'lecturer' || roleInput.value === 'admin' ? idNumInput.value : null, // Smart logic: also update staff_id if needed
            updated_at: new Date().toISOString(),
        };

        try {
            const { error } = await supabase
                .from("users")
                .update(updates)
                .eq("id", userId);

            if (error) throw error;

            alert("User updated successfully");
            editModal?.classList.add("hidden");
            editModal?.classList.remove("flex");
            window.location.reload();
        } catch (error) {
            console.error("Error updating user:", error);
            alert("Failed to update user");
        } finally {
            // Re-enable button and restore original state
            (submitButton as HTMLButtonElement).disabled = false;
            (submitButton as HTMLButtonElement).innerHTML =
                "<span>Save Changes</span>";
        }
    });



    async function loadUsers() {
        // ... (existing code)
        try {
            const { data: users, error } = await supabase
                .from("users")
                .select("*")
                .order("created_at", { ascending: false })
                .limit(10);

            if (error) throw error;

            const tbody = document.getElementById("users-table-body");
            if (!tbody) return;

            if (users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center gap-2">
                                <i class="fas fa-users text-4xl text-gray-300 mb-2"></i>
                                <span class="font-medium">No users found</span>
                                <span class="text-sm">Get started by adding a new user</span>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = users
                .map(
                    (user) => `
                <tr class="hover:bg-gray-50 transition-colors group">
                    <td class="px-4 py-4 whitespace-nowrap">
                        <input type="checkbox" class="user-checkbox w-4 h-4 rounded border-gray-300 text-[#667eea] focus:ring-[#667eea]" data-id="${user.id}">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="text-sm font-mono font-medium text-[#667eea] bg-[#667eea]/10 px-2 py-1 rounded">${user.student_id || user.staff_id || "-"}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="h-10 w-10 rounded-full bg-gradient-to-br from-[#667eea] to-[#764ba2] flex items-center justify-center text-white font-bold text-sm shadow-md">
                                ${user.name ? user.name.charAt(0).toUpperCase() : "U"}
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${user.name || "Unknown"}</div>
                                <div class="text-sm text-gray-500">${user.email || ""}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full 
                            ${
                                user.role === "admin"
                                    ? "bg-purple-100 text-purple-800"
                                    : user.role === "lecturer"
                                      ? "bg-blue-100 text-blue-800"
                                      : "bg-green-100 text-green-800"
                            }">
                            ${user.role ? user.role.charAt(0).toUpperCase() + user.role.slice(1) : "Student"}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${user.department || "-"}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-medium rounded-full ${user.profile_completed ? "bg-green-100 text-green-700" : "bg-yellow-100 text-yellow-700"}">
                            ${user.profile_completed ? "✓ Complete" : "⚠ Incomplete"}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button class="toggle-status-btn flex items-center gap-2 group/status" data-id="${user.id}" data-active="${user.is_active !== false}">
                            <span class="relative inline-flex h-5 w-9 flex-shrink-0 cursor-pointer rounded-full transition-colors duration-200 ${user.is_active !== false ? "bg-green-500" : "bg-gray-300"}">
                                <span class="inline-block h-4 w-4 transform rounded-full bg-white shadow transition duration-200 ${user.is_active !== false ? "translate-x-4" : "translate-x-0.5"} mt-0.5"></span>
                            </span>
                            <span class="text-xs font-medium ${user.is_active !== false ? "text-green-700" : "text-gray-500"}">
                                ${user.is_active !== false ? "Active" : "Inactive"}
                            </span>
                        </button>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="reset-pwd-btn text-gray-400 hover:text-orange-500 transition-colors mr-2" data-id="${user.id}" data-email="${user.email}" title="Reset Password">
                            <i class="fas fa-key pointer-events-none"></i>
                        </button>
                        <button class="edit-btn text-gray-400 hover:text-[#667eea] transition-colors mr-2" data-id="${user.id}">
                            <i class="fas fa-edit pointer-events-none"></i>
                        </button>
                        <button class="delete-btn text-gray-400 hover:text-red-600 transition-colors" data-id="${user.id}">
                            <i class="fas fa-trash pointer-events-none"></i>
                        </button>
                    </td>
                </tr>
            `,
                )
                .join("");

            // Update count
            const countEl = document.getElementById("total-count");
            if (countEl) countEl.textContent = users.length.toString();

            // Add Event Listeners via Delegation
            tbody.addEventListener("click", async (e) => {
                const target = e.target as HTMLElement;

                // Handle Delete
                if (target.classList.contains("delete-btn")) {
                    const userId = target.getAttribute("data-id");
                    if (!userId) return;

                    if (!confirm("Are you sure you want to delete this user?"))
                        return;

                    try {
                        const { error } = await supabase
                            .from("users")
                            .delete()
                            .eq("id", userId);

                        if (error) throw error;

                        alert("User deleted successfully");
                        window.location.reload();
                    } catch (error) {
                        console.error("Error deleting user:", error);
                        alert("Failed to delete user");
                    }
                }

                // Handle Edit
                if (target.closest(".edit-btn")) {
                    const button = target.closest(
                        ".edit-btn",
                    ) as HTMLButtonElement;
                    const userId = button.dataset.id;
                    if (userId) {
                        (window as any).editUser(userId);
                    }
                }

                // Handle Toggle Status
                if (target.closest(".toggle-status-btn")) {
                    const button = target.closest(
                        ".toggle-status-btn",
                    ) as HTMLButtonElement;
                    const userId = button.dataset.id;
                    const currentActive = button.dataset.active === "true";

                    if (!userId) return;

                    try {
                        const { error } = await supabase
                            .from("users")
                            .update({ is_active: !currentActive })
                            .eq("id", userId);

                        if (error) throw error;

                        // Reload to show updated status
                        loadUsers();
                    } catch (error) {
                        console.error("Error toggling status:", error);
                        alert("Failed to update user status");
                    }
                }

                // Handle Reset Password
                if (target.closest(".reset-pwd-btn")) {
                    const button = target.closest(
                        ".reset-pwd-btn",
                    ) as HTMLButtonElement;
                    const userId = button.dataset.id;
                    const userEmail = button.dataset.email;

                    if (!userId) return;

                    const newPassword = prompt(
                        `Enter new password for ${userEmail}:`,
                    );
                    if (!newPassword || newPassword.length < 6) {
                        if (newPassword !== null) {
                            alert("Password must be at least 6 characters");
                        }
                        return;
                    }

                    try {
                        // Get token from Supabase session (same as Add User)
                        const {
                            data: { session },
                        } = await supabase.auth.getSession();
                        const token = session?.access_token;

                        if (!token) {
                            throw new Error(
                                "No authentication token found. Please login again.",
                            );
                        }

                        const response = await fetch(
                            `${BACKEND_URL}/api/users/${userId}/reset-password`,
                            {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    Authorization: `Bearer ${token}`,
                                },
                                body: JSON.stringify({
                                    new_password: newPassword,
                                }),
                            },
                        );

                        if (!response.ok) {
                            throw new Error("Failed to reset password");
                        }

                        alert("Password reset successfully!");
                    } catch (error) {
                        console.error("Error resetting password:", error);
                        alert("Failed to reset password. Please try again.");
                    }
                }
            });
        } catch (error) {
            console.error("Error loading users:", error);
            const tbody = document.getElementById("users-table-body");
            if (tbody) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-red-500">
                            Failed to load users. Please check your connection.
                        </td>
                    </tr>
                `;
            }
        }
    }

    document.addEventListener("DOMContentLoaded", loadUsers);

    // Bulk Actions Logic
    document.addEventListener("DOMContentLoaded", () => {
        const selectAllCheckbox = document.getElementById(
            "select-all-users",
        ) as HTMLInputElement;
        const bulkActionBar = document.getElementById("bulk-action-bar");
        const selectedCountEl = document.getElementById("selected-count");
        const applyBulkBtn = document.getElementById("apply-bulk-action");
        const clearSelectionBtn = document.getElementById("clear-selection");
        const bulkActionSelect = document.getElementById(
            "bulk-action-select",
        ) as HTMLSelectElement;

        function updateBulkActionBar() {
            const checkboxes = document.querySelectorAll(
                ".user-checkbox:checked",
            ) as NodeListOf<HTMLInputElement>;
            const count = checkboxes.length;

            if (selectedCountEl) selectedCountEl.textContent = count.toString();

            if (count > 0) {
                bulkActionBar?.classList.remove("hidden");
                bulkActionBar?.classList.add("flex");
            } else {
                bulkActionBar?.classList.add("hidden");
                bulkActionBar?.classList.remove("flex");
            }

            // Update select-all checkbox state
            const allCheckboxes = document.querySelectorAll(
                ".user-checkbox",
            ) as NodeListOf<HTMLInputElement>;
            if (selectAllCheckbox) {
                selectAllCheckbox.checked =
                    count > 0 && count === allCheckboxes.length;
                selectAllCheckbox.indeterminate =
                    count > 0 && count < allCheckboxes.length;
            }
        }

        // Select All handler
        selectAllCheckbox?.addEventListener("change", (e) => {
            const isChecked = (e.target as HTMLInputElement).checked;
            document.querySelectorAll(".user-checkbox").forEach((cb) => {
                (cb as HTMLInputElement).checked = isChecked;
            });
            updateBulkActionBar();
        });

        // Individual checkbox handler (delegate)
        document
            .getElementById("users-table-body")
            ?.addEventListener("change", (e) => {
                if (
                    (e.target as HTMLElement).classList.contains(
                        "user-checkbox",
                    )
                ) {
                    updateBulkActionBar();
                }
            });

        // Clear selection
        clearSelectionBtn?.addEventListener("click", () => {
            document.querySelectorAll(".user-checkbox").forEach((cb) => {
                (cb as HTMLInputElement).checked = false;
            });
            if (selectAllCheckbox) selectAllCheckbox.checked = false;
            updateBulkActionBar();
        });

        // Apply bulk action
        applyBulkBtn?.addEventListener("click", async () => {
            const action = bulkActionSelect?.value;
            if (!action) {
                alert("Please select an action");
                return;
            }

            const selectedIds: string[] = [];
            document
                .querySelectorAll(".user-checkbox:checked")
                .forEach((cb) => {
                    const id = (cb as HTMLInputElement).dataset.id;
                    if (id) selectedIds.push(id);
                });

            if (selectedIds.length === 0) {
                alert("No users selected");
                return;
            }

            if (action === "delete") {
                if (
                    !confirm(
                        `Are you sure you want to delete ${selectedIds.length} user(s)?`,
                    )
                )
                    return;
            }

            try {
                for (const userId of selectedIds) {
                    if (action === "delete") {
                        await supabase.from("users").delete().eq("id", userId);
                    } else if (action === "activate") {
                        await supabase
                            .from("users")
                            .update({ is_active: true })
                            .eq("id", userId);
                    } else if (action === "deactivate") {
                        await supabase
                            .from("users")
                            .update({ is_active: false })
                            .eq("id", userId);
                    }
                }
                alert(
                    `Successfully ${action === "delete" ? "deleted" : action === "activate" ? "activated" : "deactivated"} ${selectedIds.length} user(s)`,
                );
                window.location.reload();
            } catch (error) {
                console.error("Bulk action error:", error);
                alert("Failed to perform bulk action");
            }
        });
    });
</script>
